const regionData = {
    "11": [
        { "code": "11305", "name": "강북구" },
        { "code": "11740", "name": "강동구" },
        { "code": "11680", "name": "강남구" },
        { "code": "11500", "name": "강서구" },
        { "code": "11110", "name": "종로구" },
        { "code": "11140", "name": "중구" },
        { "code": "11260", "name": "중랑구" },
        { "code": "11350", "name": "노원구" },
        { "code": "11530", "name": "구로구" },
        { "code": "11545", "name": "금천구" },
        { "code": "11320", "name": "도봉구" },
        { "code": "11230", "name": "동대문구" },
        { "code": "11590", "name": "동작구" },
        { "code": "11440", "name": "마포구" },
        { "code": "11620", "name": "관악구" },
        { "code": "11215", "name": "광진구" },
        { "code": "11170", "name": "용산구" },
        { "code": "11470", "name": "양천구" },
        { "code": "11650", "name": "서초구" },
        { "code": "11410", "name": "서대문구" },
        { "code": "11380", "name": "은평구" },
        { "code": "11290", "name": "성북구" },
        { "code": "11200", "name": "성동구" },
        { "code": "11710", "name": "송파구" },
        { "code": "11560", "name": "영등포구" }
    ],
    "26": [
        { "code": "26230", "name": "부산진구" },
        { "code": "26260", "name": "동래구" },
        { "code": "26110", "name": "중구" },
        { "code": "26140", "name": "서구" },
        { "code": "26380", "name": "사하구" },
        { "code": "26350", "name": "해운대구" },
        { "code": "26200", "name": "영도구" },
        { "code": "26410", "name": "금정구" },
        { "code": "26530", "name": "사상구" },
        { "code": "26500", "name": "수영구" },
        { "code": "26320", "name": "북구" },
        { "code": "26710", "name": "기장군" },
        { "code": "26470", "name": "연제구" },
        { "code": "26440", "name": "강서구" },
        { "code": "26170", "name": "동구" },
        { "code": "26290", "name": "남구" }
    ],
    "27": [
        { "code": "27110", "name": "중구" },
        { "code": "27170", "name": "서구" },
        { "code": "27230", "name": "북구" },
        { "code": "27260", "name": "수성구" },
        { "code": "27290", "name": "달서구" },
        { "code": "27200", "name": "남구" },
        { "code": "27710", "name": "달성군" },
        { "code": "27140", "name": "동구" }
    ],
    "28": [
        { "code": "28237", "name": "부평구" },
        { "code": "28260", "name": "서구" },
        { "code": "28185", "name": "연수구" },
        { "code": "28170", "name": "남구" },
        { "code": "28200", "name": "남동구" },
        { "code": "28245", "name": "계양구" },
        { "code": "28140", "name": "동구" },
        { "code": "28110", "name": "중구" },
        { "code": "28710", "name": "강화군" },
        { "code": "28720", "name": "옹진군" }
    ],
    "29": [
        { "code": "29155", "name": "남구" },
        { "code": "29200", "name": "광산구" },
        { "code": "29140", "name": "서구" },
        { "code": "29170", "name": "북구" },
        { "code": "29110", "name": "동구" }
    ],
    "30": [
        { "code": "30140", "name": "중구" },
        { "code": "30230", "name": "대덕구" },
        { "code": "30170", "name": "서구" },
        { "code": "30200", "name": "유성구" },
        { "code": "30110", "name": "동구" }
    ],
    "31": [
        { "code": "31110", "name": "중구" },
        { "code": "31170", "name": "동구" },
        { "code": "31140", "name": "남구" },
        { "code": "31710", "name": "울주군" },
        { "code": "31200", "name": "북구" }
    ],
    "41": [
        { "code": "41820", "name": "가평군" },
        { "code": "41210", "name": "광명시" },
        { "code": "41610", "name": "광주시" },
        { "code": "41310", "name": "구리시" },
        { "code": "41410", "name": "군포시" },
        { "code": "41570", "name": "김포시" },
        { "code": "41360", "name": "남양주시" },
        { "code": "41281", "name": "고양시덕양구" },
        { "code": "41287", "name": "고양시일산서구" },
        { "code": "41285", "name": "고양시일산동구" },
        { "code": "41131", "name": "성남시수정구" },
        { "code": "41133", "name": "성남시중원구" },
        { "code": "41135", "name": "성남시분당구" },
        { "code": "41150", "name": "의정부시" },
        { "code": "41430", "name": "의왕시" },
        { "code": "41500", "name": "이천시" },
        { "code": "41461", "name": "용인시처인구" },
        { "code": "41465", "name": "용인시수지구" },
        { "code": "41463", "name": "용인시기흥구" },
        { "code": "41390", "name": "시흥시" },
        { "code": "41800", "name": "연천군" },
        { "code": "41730", "name": "여주군" },
        { "code": "41830", "name": "양평군" },
        { "code": "41630", "name": "양주시" },
        { "code": "41173", "name": "안양시동안구" },
        { "code": "41171", "name": "안양시만안구" },
        { "code": "41550", "name": "안성시" },
        { "code": "41273", "name": "안산시단원구" },
        { "code": "41271", "name": "안산시상록구" },
        { "code": "41115", "name": "수원시팔달구" },
        { "code": "41117", "name": "수원시영통구" },
        { "code": "41111", "name": "수원시장안구" },
        { "code": "41113", "name": "수원시권선구" },
        { "code": "41480", "name": "파주시" },
        { "code": "41590", "name": "화성시" }
    ],
    "42": [
        { "code": "42790", "name": "화천군" },
        { "code": "42190", "name": "태백시" },
        { "code": "42720", "name": "홍천군" },
        { "code": "42760", "name": "평창군" },
        { "code": "42110", "name": "춘천시" },
        { "code": "42770", "name": "정선군" },
        { "code": "42810", "name": "인제군" },
        { "code": "42130", "name": "원주시" },
        { "code": "42750", "name": "영월군" },
        { "code": "42830", "name": "양양군" },
        { "code": "42800", "name": "양구군" },
        { "code": "42820", "name": "고성군" },
        { "code": "42230", "name": "삼척시" },
        { "code": "42170", "name": "동해시" },
        { "code": "42210", "name": "속초시" },
        { "code": "42150", "name": "강릉시" },
        { "code": "42780", "name": "철원군" }
    ],
    "43": [
        { "code": "43760", "name": "괴산군" },
        { "code": "43770", "name": "음성군" },
        { "code": "43710", "name": "청원군" },
        { "code": "43720", "name": "보은군" },
        { "code": "43750", "name": "진천군" },
        { "code": "43113", "name": "청주시흥덕구" },
        { "code": "43111", "name": "청주시상당구" },
        { "code": "43130", "name": "충주시" },
        { "code": "43150", "name": "제천시" },
        { "code": "43745", "name": "증평군" },
        { "code": "43740", "name": "영동군" },
        { "code": "43730", "name": "옥천군" },
        { "code": "43800", "name": "단양군" }
    ],
    "44": [
        { "code": "44790", "name": "청양군" },
        { "code": "44800", "name": "홍성군" },
        { "code": "44810", "name": "예산군" },
        { "code": "44230", "name": "논산시" },
        { "code": "44730", "name": "연기군" },
        { "code": "44825", "name": "태안군" },
        { "code": "44200", "name": "아산시" },
        { "code": "44770", "name": "서천군" },
        { "code": "44210", "name": "서산시" },
        { "code": "44760", "name": "부여군" },
        { "code": "44180", "name": "보령시" },
        { "code": "44830", "name": "당진군" },
        { "code": "44710", "name": "금산군" },
        { "code": "44150", "name": "공주시" },
        { "code": "44130", "name": "천안시" },
        { "code": "44250", "name": "계룡시" }
    ],
    "45": [
        { "code": "45720", "name": "진안군" },
        { "code": "45740", "name": "장수군" },
        { "code": "45113", "name": "전주시덕진구" },
        { "code": "45111", "name": "전주시완산구" },
        { "code": "45790", "name": "고창군" },
        { "code": "45750", "name": "임실군" },
        { "code": "45140", "name": "익산시" },
        { "code": "45710", "name": "완주군" },
        { "code": "45800", "name": "부안군" },
        { "code": "45190", "name": "남원시" },
        { "code": "45210", "name": "김제시" },
        { "code": "45130", "name": "군산시" },
        { "code": "45730", "name": "무주군" },
        { "code": "45770", "name": "순창군" }
    ],
    "46": [
        { "code": "46820", "name": "해남군" },
        { "code": "46860", "name": "함평군" },
        { "code": "46900", "name": "진도군" },
        { "code": "46800", "name": "장흥군" },
        { "code": "46880", "name": "장성군" },
        { "code": "46890", "name": "완도군" },
        { "code": "46830", "name": "영암군" },
        { "code": "46870", "name": "영광군" },
        { "code": "46130", "name": "여수시" },
        { "code": "46910", "name": "신안군" },
        { "code": "46780", "name": "보성군" },
        { "code": "46840", "name": "무안군" },
        { "code": "46110", "name": "목포시" },
        { "code": "46710", "name": "담양군" },
        { "code": "46170", "name": "나주시" },
        { "code": "46730", "name": "구례군" },
        { "code": "46230", "name": "광양시" },
        { "code": "46720", "name": "곡성군" },
        { "code": "46770", "name": "고흥군" },
        { "code": "46810", "name": "강진군" },
        { "code": "46150", "name": "순천시" }
    ],
    "47": [
        { "code": "47111", "name": "포항시남구" },
        { "code": "47113", "name": "포항시북구" },
        { "code": "47850", "name": "칠곡군" },
        { "code": "47750", "name": "청송군" },
        { "code": "47820", "name": "청도군" },
        { "code": "47730", "name": "의성군" },
        { "code": "47930", "name": "울진군" },
        { "code": "47940", "name": "울릉군" },
        { "code": "47900", "name": "예천군" },
        { "code": "47230", "name": "영천시" },
        { "code": "47210", "name": "영주시" },
        { "code": "47760", "name": "영양군" },
        { "code": "47770", "name": "영덕군" },
        { "code": "47170", "name": "안동시" },
        { "code": "47840", "name": "성주군" },
        { "code": "47250", "name": "상주시" },
        { "code": "47920", "name": "봉화군" },
        { "code": "47280", "name": "문경시" },
        { "code": "47150", "name": "김천시" },
        { "code": "47720", "name": "군위군" },
        { "code": "47190", "name": "구미시" },
        { "code": "47830", "name": "고령군" },
        { "code": "47130", "name": "경주시" },
        { "code": "47290", "name": "경산시" }
    ],
    "48": [
        { "code": "48860", "name": "산청군" },
        { "code": "48840", "name": "남해군" },
        { "code": "48250", "name": "김해시" },
        { "code": "48820", "name": "고성군" },
        { "code": "48880", "name": "거창군" },
        { "code": "48310", "name": "거제시" },
        { "code": "48720", "name": "의령군" },
        { "code": "48220", "name": "통영시" },
        { "code": "48110", "name": "창원시" },
        { "code": "48740", "name": "창녕군" },
        { "code": "48190", "name": "진해시" },
        { "code": "48170", "name": "진주시" },
        { "code": "48730", "name": "함안군" },
        { "code": "48890", "name": "합천군" },
        { "code": "48850", "name": "하동군" },
        { "code": "48240", "name": "사천시" },
        { "code": "48330", "name": "양산시" },
        { "code": "48160", "name": "마산시" }
    ],
    "50": [
        { "code": "50110", "name": "제주시" },
        { "code": "50130", "name": "서귀포시" }
    ]
};



$(document).ready(function () {
	var regionMarkers = [];
	var gasStationMarkers = [];
	
	function clearRegionMarkers() {
    regionMarkers.forEach(marker => marker.setMap(null)); // 지도에서 모든 마커 제거
    regionMarkers = []; // 배열 초기화
}

	function clearGasStationMarkers() {
    gasStationMarkers.forEach(marker => marker.setMap(null)); // 지도에서 모든 마커 제거
    gasStationMarkers = []; // 배열 초기화
}

    var startMarkerImage = createMarkerImage('https://t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/blue_b.png', 32);
    var endMarkerImage = createMarkerImage('https://t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/red_b.png', 32);
    var centerImage = createMarkerImage('../resources/images/centermarker.png', 32);


function addRegionMarker(coords, title) {
    clearRegionMarkers(); // 기존 마커 초기화
	clearGasStationMarkers();
	
    const marker = new kakao.maps.Marker({
        position: coords,
        map: map,
        title: title,
        image: centerImage // 마커 이미지 (필요시 다른 이미지로 설정 가능)
    });

    regionMarkers.push(marker); // 새 마커를 배열에 저장
    map.setCenter(coords); // 지도 중심 이동
    console.log("지역별 마커 추가:", title, coords);
}
	
    // 지도 설정 코드
    var mapContainer = document.getElementById('map');
    var mapOption = {
        center: new kakao.maps.LatLng(36.8073, 127.1471),
        level: 6
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); 

    var ps = new kakao.maps.services.Places();

    function createMarkerImage(src, size) {
        return new kakao.maps.MarkerImage(src, new kakao.maps.Size(size, size));
    }

	
	
	function getSelectedFilters() {
    // 부가정보 필터 상태 확인
    const additionalFilters = {};
    $('.additional-info input[type="checkbox"]').each(function () {
        const labelText = $(this).parent().text().trim(); // 체크박스 옆 텍스트 가져오기
        const isChecked = $(this).is(':checked'); // 체크박스 상태
        additionalFilters[labelText] = isChecked;
    });

    // 상표 필터 상태 확인 (체크박스 옆 텍스트로 가져오기)
    const brandFilters = [];
    $('.brand-info input[type="checkbox"]:checked').each(function () {
        const labelText = $(this).parent().text().trim(); // 체크박스 옆 텍스트 가져오기
        brandFilters.push(labelText); // 텍스트를 배열에 추가
    });

    console.log('최종 부가정보 필터:', additionalFilters);
    console.log('최종 상표 필터:', brandFilters);

    return { additionalFilters, brandFilters };
}

	
	

    
    proj4.defs("EPSG:5178", "+proj=tmerc +lat_0=38 +lon_0=128 +k=0.9999 +x_0=400000 +y_0=600000 +ellps=GRS80 +units=m +no_defs");
	proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");

async function getoilgas(coords) {
    clearGasStationMarkers(); // 기존 주유소 마커 초기화

    const regionY = coords.La; // 위도
    const regionX = coords.Ma; // 경도

    const [katecX, katecY] = proj4("EPSG:4326", "EPSG:5178", [regionY, regionX]);

    console.log("WGS84 좌표 -> KATEC 변환: X=" + katecX + ", Y=" + katecY);

    try {
        const response = await $.ajax({
            url: 'getNearbyStations',
            method: 'GET',
            data: {
                x: katecX,
                y: katecY,
                radius: 4000,
                sort: 1,
                prodcd: 'B027'
            }
        });

        let stationList = response.RESULT?.OIL || [];
        console.log("주유소 기본 데이터 수신:", stationList);

        if (!stationList.length) {
            updateGasList([]); // 빈 리스트 처리
            return;
        }

        // 상세 정보 병합
        const detailedStationList = await Promise.all(
            stationList.map(async (station) => {
                const details = await fetchStationDetails(station.UNI_ID);
                return { ...station, ...details }; // 병합된 데이터 반환
            })
        );

        console.log("병합된 주유소 상세 데이터:", detailedStationList);

        // **필터링 조건 적용**
        const { additionalFilters, brandFilters } = getSelectedFilters(); // 수정된 getSelectedFilters 호출
        console.log("적용된 부가정보 필터:", additionalFilters);
        console.log("적용된 상표 필터:", brandFilters);

        const filteredStations = detailedStationList.filter(station => {
    let matchesBrand = true;
    let matchesAdditional = true;

    // 상표 필터 조건
    if (brandFilters.length > 0) {
    	console.log('brandFilters:', brandFilters);
		console.log('station.POLL_DIV_CO:', station.POLL_DIV_CO);
        matchesBrand = brandFilters.includes(station.POLL_DIV_CO);
    }

    // 부가정보 필터 조건
    if (Object.keys(additionalFilters).some(filter => additionalFilters[filter])) {
        matchesAdditional = Object.keys(additionalFilters).every(filter => {
            if (additionalFilters[filter]) {
                switch (filter) {
                    case "세차장":
                        return station.CAR_WASH_YN === "Y";
                    case "경정비":
                        return station.MAINT_YN === "Y";
                    case "편의점":
                        return station.CVS_YN === "Y";
                    case "품질인증":
                        return station.KPETRO_YN === "Y";
                    default:
                        return true;
                }
            }
            return true;
        });
    }

    // 상표 필터와 부가정보 필터를 모두 만족하는 경우 반환
    return matchesBrand && matchesAdditional;
});



        // 필터링된 데이터로 UI 업데이트
        updateGasList(filteredStations);
        console.log("updateGasList 호출된 데이터:", filteredStations);

        // 지도에 마커 표시
        filteredStations.forEach(station => {
            let [lng, lat] = proj4("EPSG:5178", "EPSG:4326", [station.GIS_X_COOR, station.GIS_Y_COOR]);

            lng -= 0.00223; // 좌표 보정
            lat += 0.00275;

            const coords = new kakao.maps.LatLng(lat, lng);

            // 마커 생성 및 배열에 저장
            const marker = new kakao.maps.Marker({
                position: coords,
                map: map,
                title: station.OS_NM
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                displayStationInfo(station); // 주유소 정보 표시
                map.setCenter(coords);
            });

            gasStationMarkers.push(marker); // 배열에 저장
        });

    } catch (error) {
        console.error("오류 발생:", error);
    }
}




$('.additional-info input[type="checkbox"], .brand-info input[type="checkbox"]').on('change', function () {
    const { additionalFilters, brandFilters } = getSelectedFilters();
    console.log("적용된 부가정보 필터:", additionalFilters);
    console.log("적용된 상표 필터:", brandFilters);

    // 필터링 로직 재적용
    logSelections(); // 또는 getoilgas() 호출
});


$('#sido, #city, #town').on('change', logSelections);

async function getoilgasroute(coords) {
    const regionY = coords.La; // 위도
    const regionX = coords.Ma; // 경도

    // KATEC 변환
    const [katecX, katecY] = proj4("EPSG:4326", "EPSG:5178", [regionY, regionX]);
    console.log("WGS84 좌표 -> KATEC 변환: X=" + katecX + ", Y=" + katecY);

    try {
        const response = await $.ajax({
            url: 'getNearbyStations',
            method: 'GET',
            data: {
                x: katecX,
                y: katecY,
                radius: 200, // 반경 1km (필요에 따라 조정)
                sort: 1,
                prodcd: 'B027'
            }
        });

        const stationList = response.RESULT?.OIL || [];
        console.log("주유소 데이터 수신:", stationList);
        
        // 상세 정보 병합
        const detailedStationList = await Promise.all(
            stationList.map(async (station) => {
                const details = await fetchStationDetails(station.UNI_ID);
                return { ...station, ...details }; // 병합된 데이터 반환
            })
        );

        // 중복 제거
        const uniqueStations = detailedStationList.filter(
            (station, index, self) =>
                index === self.findIndex((s) => s.UNI_ID === station.UNI_ID)
        );

        console.log("중복 제거된 주유소 목록:", uniqueStations);

        // 지도에 주유소 마커 표시
        uniqueStations.forEach(station => {
        
            let [lng, lat] = proj4("EPSG:5178", "EPSG:4326", [station.GIS_X_COOR, station.GIS_Y_COOR]);

            lng -= 0.00223; // 좌표 보정
            lat += 0.00275;

            const coords = new kakao.maps.LatLng(lat, lng);

            const marker = new kakao.maps.Marker({
                position: coords,
                map: map,
                title: station.OS_NM
            });

            gasStationMarkers.push(marker); // 마커를 배열에 저장

            kakao.maps.event.addListener(marker, 'click', function () {
                displayStationInfo(station); // 주유소 정보 표시
                map.setCenter(coords);
            });
        });

    } catch (error) {
        console.error("주유소 탐색 오류:", error);
    }
}




// 주유소 상세 정보를 가져오는 함수
async function fetchStationDetails(stationId) {
    try {
        const response = await $.ajax({
            url: 'getStationDetails', // 새로운 컨트롤러 엔드포인트
            method: 'GET',
            data: { id: stationId }
        });

        console.log(`상세 정보 수신 [ID: ${stationId}]`, response.RESULT?.OIL?.[0] || {});
        return response.RESULT?.OIL?.[0] || {};
    } catch (error) {
        console.error(`상세 정보 조회 오류 [ID: ${stationId}]`, error);
        return {}; // 기본 빈 객체 반환
    }
}

// UI에 주유소 리스트 업데이트
function updateGasList(stationList) {
    const gasListContainer = $('.gaslist');
    gasListContainer.empty();

    if (!stationList.length) {
        gasListContainer.append('<p>주유소 정보를 찾을 수 없습니다.</p>');
        return;
    }

    const brandMapping = {
        "SKE": "SK에너지",
        "GSC": "GS칼텍스",
        "HDO": "현대오일뱅크",
        "SOL": "S-OIL",
        "RTE": "자영알뜰",
        "RTX": "고속도로알뜰",
        "농협알뜰자가상표가스N": "농협알뜰자"
    };

    stationList.forEach((station, index) => {
        const brandName = brandMapping[station.POLL_DIV_CD] || "알 수 없음";

        const gasInfo = `
            <div class="gas-item" data-index="${index}">
                <p><strong>${index + 1}. ${station.OS_NM}</strong></p>
                <p>상표명: ${brandName}</p>
                <p>주소: ${station.NEW_ADR || station.VAN_ADR || "정보 없음"}</p>
                <p>전화번호: ${station.TEL || "정보 없음"}</p>
            </div>
        `;
        gasListContainer.append(gasInfo);
    });

    // 리스트 항목 클릭 이벤트 추가
    $('.gas-item').on('click', function () {
        const index = $(this).data('index'); // 클릭된 항목의 index 가져오기
        const selectedStation = stationList[index]; // 해당 index로 station 가져오기
        

        // 상세 정보 표시 함수 호출
        displayStationInfo(selectedStation);
        
        let [lng, lat] = proj4("EPSG:5178", "EPSG:4326", [selectedStation.GIS_X_COOR, selectedStation.GIS_Y_COOR]);

            lng -= 0.00223; // 좌표 보정
            lat += 0.00275;
        
            const coords = new kakao.maps.LatLng(lat, lng);

    map.setCenter(coords); // 지도 중심 이동
        

        console.log(`리스트 클릭: ${selectedStation}`);
    });

    console.log("주유소 리스트 업데이트 완료.");
}

function displayStationInfo(station) {
    const infoBox = document.getElementById('stationInfoBox'); // 주유소 정보 박스
    const stationName = document.getElementById('stationName');
    const stationTableBody = document.querySelector('#stationTable tbody');
    const detaillines = document.querySelectorAll('.detailline p'); // 상세정보 칸
    const infoBoxContent = document.querySelector('#stationInfoBox'); // 기타 정보 포함 박스

    // 주유소 이름 설정
    stationName.textContent = station.OS_NM;
    
    // oilKND와 CONM 설정
    $('#oilKND').text(() => {
        if (station.LPG_YN === 'N') {
            return '주유소';
        } else if (station.LPG_YN === 'Y') {
            return '자동차 충전소';
        } else if (station.LPG_YN === 'C') {
            return '주유소/충전소 (겸업)';
        } else {
            return '정보 없음';
        }
    });
    
    const brandMapping = {
        "SKE": "SK에너지",
        "GSC": "GS칼텍스",
        "HDO": "현대오일뱅크",
        "SOL": "S-OIL",
        "RTE": "자영알뜰",
        "RTX": "고속도로알뜰",
        "농협알뜰자가상표가스N": "농협알뜰자"
    };
    
    const brandName = brandMapping[station.POLL_DIV_CD] || '정보 없음';
    $('#CONM').text(brandName || '정보 없음');

    // 기존 테이블 내용 초기화
    stationTableBody.innerHTML = '';

    // 연료 가격 데이터 추가
    const prices = station.OIL_PRICE || []; // OIL_PRICE 배열
    const priceMap = {
        B027: '휘발유',
        D047: '경유',
        B034: '고급휘발유',
        C004: '실내등유',
        K015: '자동차부탄'
    };

    prices.forEach(price => {
        const fuelName = priceMap[price.PRODCD] || '기타';
        const row = `
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${fuelName}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${price.PRICE ? price.PRICE + '원' : '정보 없음'}</td>
            </tr>
        `;
        stationTableBody.insertAdjacentHTML('beforeend', row);
    });

    // 상세 정보 데이터 추가
    detaillines[0].textContent = station.VAN_ADR || '정보 없음'; // 지번주소
    detaillines[1].textContent = station.NEW_ADR || '정보 없음'; // 도로명주소
    detaillines[2].textContent = station.TEL || '정보 없음'; // 전화번호
    detaillines[3].textContent = station.OIL_PRICE?.[0]?.TRADE_DT || '정보 없음'; // 기준일자
    detaillines[4].textContent = station.OIL_PRICE?.[0]?.TRADE_TM || '정보 없음'; // 기준시간

    // 기타 정보 초기화
    const additionalInfoContainer = document.querySelector('#stationInfoBox > .additional-info');
    if (additionalInfoContainer) {
        additionalInfoContainer.remove(); // 기존의 기타 정보를 제거
    }

    // 기타 정보 추가
    const additionalInfo = [
        { label: '경정비', value: station.MAINT_YN },
        { label: '세차장', value: station.CAR_WASH_YN },
        { label: '편의점', value: station.CVS },
        { label: '품질인증', value: station.QUALITY_YN }
    ];
    const additionalInfoHTML = `
        <div class="additional-info">
            ${additionalInfo.map(info => 
                `<div>${info.label}: ${info.value === 'Y' ? '있음' : '없음'}</div>`
            ).join('')}
        </div>
    `;
    infoBoxContent.insertAdjacentHTML('beforeend', additionalInfoHTML);

    // 박스를 화면에 표시
    infoBox.style.display = 'flex';
}




let startMarker = null;
let endMarker = null;

function addMarker(coords, type) {
    console.log(`마커 추가 요청: 타입=${type}, 좌표=`, coords);

    // 타입에 따라 기존 마커를 제거
    if (type === 'start' && startMarker) {
        startMarker.setMap(null); // 기존 출발지 마커 제거
        startMarker = null;
    }
    if (type === 'end' && endMarker) {
        endMarker.setMap(null); // 기존 도착지 마커 제거
        endMarker = null;
    }

    // 마커 이미지 선택
    const markerImage = type === 'start' ? startMarkerImage : endMarkerImage;

    // 새로운 마커 생성
    const newMarker = new kakao.maps.Marker({
        map: map,
        position: coords,
        image: markerImage
    });

    // 타입에 따라 새 마커를 저장
    if (type === 'start') {
        startMarker = newMarker;
        map.setCenter(coords); // 출발지일 때 지도 중심 이동
    } else if (type === 'end') {
        endMarker = newMarker;
    }

    console.log(`${type} 마커가 성공적으로 추가되었습니다.`, newMarker);
}







    async function getRoute(startCoords, endCoords) {
        const origin = startCoords.La + "," + startCoords.Ma;
        const destination = endCoords.La + "," + endCoords.Ma;

        const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${origin}&destination=${destination}&road_details=true`;
        console.log("경로 탐색 시작: 출발지", origin, "도착지", destination);

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'KakaoAK 88b9eda321e3ff7b739f49ab61a95ca6',
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`경로 탐색 실패: ${response.status}`);
            }

            const data = await response.json();
            console.log("경로 탐색 성공:", data);
            return data;

        } catch (error) {
            console.error("자동차 경로 탐색 오류:", error);
            alert("경로를 탐색하는 데 문제가 발생했습니다.");
        }
    }



    function computeDistanceBetween(coord1, coord2) {
    const R = 6371000; // 지구의 반지름 (미터)
    const toRad = (angle) => (angle * Math.PI) / 180;

    const lat1 = coord1.getLat();
    const lon1 = coord1.getLng();
    const lat2 = coord2.getLat();
    const lon2 = coord2.getLng();

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // 거리 반환 (미터 단위)
}

function filterLinePath(linePath, distanceThreshold = 100) {
    const filteredPath = [linePath[0]]; // 첫 좌표는 포함

    for (let i = 1; i < linePath.length; i++) {
        const last = filteredPath[filteredPath.length - 1];
        const current = linePath[i];

        const distance = computeDistanceBetween(last, current);

        if (distance > distanceThreshold) {
            filteredPath.push(current);
        }
    }

    return filteredPath;
}

// 전역 변수로 Polyline 선언
let currentPolyline = null;

async function drawRoute(routeData) {
    try {
        const linePath = [];
        const bounds = new kakao.maps.LatLngBounds(); // 경로 전체를 포함할 LatLngBounds 생성

        // 기존 Polyline 초기화
        if (currentPolyline) {
            currentPolyline.setMap(null); // 이전 Polyline 제거
            currentPolyline = null;
        }

        // 각 도로(segment)에 대해 반복
        routeData.routes[0].sections[0].roads.forEach(road => {
            road.vertexes.forEach((vertex, index) => {
                // 짝수 인덱스는 x(lng), 다음 인덱스는 y(lat)
                if (index % 2 === 0) {
                    const latLng = new kakao.maps.LatLng(road.vertexes[index + 1], road.vertexes[index]);
                    linePath.push(latLng);
                    bounds.extend(latLng); // LatLngBounds에 추가
                }
            });
        });

        // 좌표 필터링
        const filteredPath = filterLinePath(linePath, 100); // 100m 간격으로 필터링

        // 새로운 Polyline 생성
        currentPolyline = new kakao.maps.Polyline({
            path: linePath,
            strokeWeight: 5,
            strokeColor: '#FF0000',
            strokeOpacity: 0.7,
            strokeStyle: 'solid'
        });

        currentPolyline.setMap(map); // 지도에 Polyline 추가
        map.setBounds(bounds); // 경로를 지도에 맞게 조정

        console.log("Polyline 경로가 지도에 성공적으로 그려졌습니다.");

        // 병렬로 주유소 검색
        const searchPromises = [];
        filteredPath.forEach(coords => searchPromises.push(getoilgasroute(coords)));

        await Promise.all(searchPromises);

        console.log("모든 주유소 검색이 완료되었습니다.");
    } catch (error) {
        console.error("Polyline 그리기 오류 발생:", error);
        alert("경로를 그리는 중 오류가 발생했습니다.");
    }
}





    function createAutocompleteList(inputElement) {
        var list = $('<div class="destinationlist"></div>');
        $(inputElement).after(list);
        return list;
    }

    function displayAutocompleteResults(data, listElement, type) {
        listElement.empty();
        data.forEach(function (place) {
            var listItem = $('<p>' + place.place_name + '</p>');
            listItem.on('click', function () {
                var coords = new kakao.maps.LatLng(place.y, place.x);
                addMarker(coords, type);
                listElement.empty();
                $('#' + type + 'Point').val(place.place_name);
                if (type === 'start') {
    addMarker(coords, 'start');
}
if (type === 'end') {
    addMarker(coords, 'end');
}
            });
            listElement.append(listItem);
        });
    }

    function searchAutocomplete(keyword, listElement, type) {
        if (!keyword.trim()) {
            listElement.empty();
            return;
        }
        ps.keywordSearch(keyword, function (data, status) {
            if (status === kakao.maps.services.Status.OK) {
                displayAutocompleteResults(data, listElement, type);
            } else {
                listElement.empty();
            }
        });
    }

    var startList = createAutocompleteList('#startPoint');
    var endList = createAutocompleteList('#endPoint');

    $('#startPoint').on('input', function () {
        var keyword = $(this).val();
        searchAutocomplete(keyword, startList, 'start');
    });

    $('#endPoint').on('input', function () {
        var keyword = $(this).val();
        searchAutocomplete(keyword, endList, 'end');
    });
    
    $('.resetbutton').on('click', function() {
    // 출발지와 도착지 마커 제거
    if (startMarker) {
        startMarker.setMap(null); // 출발지 마커 제거
        startMarker = null;
    }
    if (endMarker) {
        endMarker.setMap(null); // 도착지 마커 제거
        endMarker = null;
    }

    // 입력 필드 초기화
    $('#startPoint').val(''); // 출발지 입력 필드 초기화
    $('#endPoint').val(''); // 도착지 입력 필드 초기화

    // 경로 폴리라인 제거
    if (currentPolyline) {
        currentPolyline.setMap(null); // 기존 경로 제거
        currentPolyline = null;
    }

    // 지도 중심 초기화 (원하는 좌표로 설정, 여기서는 기본 지도 중심으로)
    const defaultCenter = new kakao.maps.LatLng(36.8073, 127.1471);
    map.setCenter(defaultCenter);
    map.setLevel(6); // 초기 줌 레벨로 재설정

    // 경로 가이드 초기화
    $('.startnavi').empty();
    $('.routenavi').empty();
    $('.endnavi').empty();

    console.log("출발지, 도착지, 경로가 초기화되었습니다.");
});


const typeIconMap = {
    0: "https://img.icons8.com/?size=100&id=100000&format=png&color=000000", //직진
    1: "https://img.icons8.com/?size=100&id=3187&format=png&color=000000", //좌회전
    2: "https://img.icons8.com/?size=100&id=3241&format=png&color=000000", //우회전
    3: "https://img.icons8.com/?size=100&id=bmQbiY8FGmK2&format=png&color=000000", //U턴
    5: "https://img.icons8.com/?size=100&id=39785&format=png&color=000000", //왼쪽 방향
    6: "https://img.icons8.com/?size=100&id=39782&format=png&color=000000", //오른쪽 방향
    7: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //고속 도로 출구
    8: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //왼쪽에 고속 도로 출구
    9: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //오른쪽에 고속 도로 출구
    10: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000g", //고속 도로 입구
    11: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //왼쪽에 고속 도로 입구
    12: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //오른쪽에 고속 도로 입구
    14: "https://img.icons8.com/?size=100&id=AFbGHolwIW9w&format=png&color=000000", //고가도로 진입
    15: "https://img.icons8.com/?size=100&id=pSpQa6iHwEJ9&format=png&color=000000", //지하 차도 진입
    16: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //고가 도로 옆길
    17: "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //지하 차도 옆길
    18 : "https://img.icons8.com/?size=100&id=43689&format=png&color=000000", //오른쪽 1시 방향
    19 : "https://img.icons8.com/?size=100&id=43689&format=png&color=000000", //오른쪽 2시 방향
    20 : "https://img.icons8.com/?size=100&id=39782&format=png&color=000000", //오른쪽 3시 방향
    21 : "https://img.icons8.com/?size=100&id=43690&format=png&color=000000", //오른쪽 4시 방향
    22 : "https://img.icons8.com/?size=100&id=43690&format=png&color=000000", //오른쪽 5시 방향
    23 : "https://img.icons8.com/?size=100&id=7800&format=png&color=000000", //6시 방향
    24 : "https://img.icons8.com/?size=100&id=43691&format=png&color=000000", //왼쪽 7시 방향
    25 : "https://img.icons8.com/?size=100&id=43691&format=png&color=000000", //왼쪽 8시 방향
    26 : "https://img.icons8.com/?size=100&id=39785&format=png&color=000000", //왼쪽 9시 방향
    27 : "https://img.icons8.com/?size=100&id=43688&format=png&color=000000", //왼쪽 10시 방향
    28 : "https://img.icons8.com/?size=100&id=43688&format=png&color=000000", //왼쪽 11시 방향
    29 : "https://img.icons8.com/?size=100&id=39778&format=png&color=000000", //12시 방향
    30 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 오른쪽 1시 방향
    31 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 오른쪽 2시방향
    32 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 오른쪽 2시방향
    33 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 오른쪽 4시방향
    34 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 오른쪽 5시방향
    35 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 6시방향
    36 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 왼쪽 7시방향
    37 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 왼쪽 8시방향
    38 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 왼쪽 9시방향
    39 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 왼쪽 10시방향
    40 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 왼쪽 11시방향
    41 : "https://img.icons8.com/?size=100&id=A3wGuAmOGwpo&format=png&color=000000", //로터리에서 왼쪽 12시방향
    42 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //도시 고속 도로 출구
    43 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //왼쪽에 도시 고속 도로 출구 
    44 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //오른쪽에 도시 고속 도로 출구
    45 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //도시 고속 도로 입구
    46 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //왼쪽에 도시 고속 도로 입구
    47 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //오른쪽에 도시 고속 도로 입구
    48 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //왼쪽 고속 도로 진입
    49 : "https://img.icons8.com/?size=100&id=62912&format=png&color=000000", //오른쪽 고속 도로 진입
    61 : "https://img.icons8.com/?size=100&id=9328&format=png&color=000000", //페리 항로 진입
    62 : "https://img.icons8.com/?size=100&id=9328&format=png&color=000000", //페리 항로 진출
    70 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 오른쪽 1시 방향
    71 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 오른쪽 2시 방향
    72 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 오른쪽 3시 방향
    73 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 오른쪽 4시 방향
    74 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 오른쪽 5시 방향
    75 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 6시 방향
    76 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 왼쪽 7시 방향
    77 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 왼쪽 8시 방향
    78 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 왼쪽 9시 방향
    79 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 왼쪽 10시 방향
    80 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 왼쪽 11시 방향
    81 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //회전 교차로에서 12시 방향
    82 : "https://img.icons8.com/?size=100&id=100000&format=png&color=000000", //왼쪽 직진
    83 : "https://img.icons8.com/?size=100&id=100000&format=png&color=000000", //오른쪽 직진
    84 : "https://img.icons8.com/?size=100&id=61510&format=png&color=000000", //톨게이트 진입
    85 : "https://img.icons8.com/?size=100&id=36519&format=png&color=000000", //원톨링 진입
    86 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //분기 후 합류 구간 진입
    100 : "https://t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/blue_b.png", //출발지
    101 : "https://t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/red_b.png", //목적지
    300 : "https://img.icons8.com/?size=100&id=7758&format=png&color=000000", //톨게이트
    301 : "https://img.icons8.com/?size=100&id=avzgbKiLzCFk&format=png&color=000000" // 휴게소
    
};
    
async function displayGuideSteps(routeData) {
    const startNavi = document.querySelector('.startnavi');
    const routeNavi = document.querySelector('.routenavi');
    const endNavi = document.querySelector('.endnavi');

    // 초기화
    startNavi.innerHTML = '';
    routeNavi.innerHTML = '';
    endNavi.innerHTML = '';

    try {
        // 출발지 정보
        let totalDistance = routeData.routes[0].summary.distance || 0; // 총 거리 (미터)
        let totalDuration = routeData.routes[0].summary.duration || 0; // 총 시간 (초)
        const originName = document.getElementById("startPoint").value;
        const desName = document.getElementById("endPoint").value;
        
        console.log(totalDistance);

        const distanceInKm = Math.floor(totalDistance / 1000); // 거리 (km)
        const distanceInMeters = totalDistance % 1000;
        const durationInMinutes = Math.floor(totalDuration / 60); // 총 시간 (분)
        const hours = Math.floor(durationInMinutes / 60); // 시간 계산
        const minutes = durationInMinutes % 60; // 나머지 분 계산

        // startNavi에 한 번만 설정
        if (startNavi.innerHTML.trim() === '') {
            startNavi.innerHTML = `
                <p>총 이동 예상 시간: ${hours > 0 ? `${hours}시간 ` : ''}${minutes}분</p>
                <p>총 거리: ${totalDistance >= 1000 ? `${distanceInKm} km` : `${totalDistance} m`}</p>
            `;
        }

        // 경로 단계 정보
        const guideSteps = routeData.routes[0].sections[0].guides;

guideSteps.forEach((step, index) => {
    const iconUrl = typeIconMap[step.type] || ''; // 경로 안내 아이콘
    const stepElement = document.createElement('div');
    stepElement.classList.add('guide-step');

    // 첫 번째 단계는 "출발지"로 특별 처리
    if (index === 0 && step.distance === 0) {
        stepElement.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <img src="${iconUrl}" alt="아이콘" style="width:24px; height:24px; margin-right:10px;">
                <div>
                    <span>${originName || '알 수 없음'}</span>
                </div>
            </div>
            <hr>
        `;
    } else {
        // 일반 단계 처리
        stepElement.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <img src="${iconUrl}" alt="아이콘" style="width:24px; height:24px; margin-right:10px;">
                <div>
                    <span>${step.distance >= 1000 ? (step.distance / 1000).toFixed(2) + ' km' : step.distance + ' m'} 이동 후</span>
                    <span>${step.guidance}</span>
                </div>
            </div>
            <hr>
        `;
    }

    routeNavi.appendChild(stepElement);
});

        // 도착지 정보
        endNavi.innerHTML = `
            <h3>도착지:${desName}</h3>
        `;

        console.log("가이드 단계 데이터가 성공적으로 표시되었습니다.");
    } catch (error) {
        console.error("가이드 데이터를 처리하는 중 오류 발생:", error);
    }
}

$('.Gasroute-btn').on('click', async function () {
	clearRegionMarkers();
    clearGasStationMarkers();

    if (startMarker && endMarker) {
        console.log("경로 검색 실행. 출발지:", startMarker.getPosition().getLat(), startMarker.getPosition().getLng());
        console.log("도착지:", endMarker.getPosition().getLat(), endMarker.getPosition().getLng());

        const routeData = await getRoute(startMarker.getPosition(), endMarker.getPosition());
        if (routeData) {
            drawRoute(routeData); // 경로 그리기
            displayGuideSteps(routeData); // 단계 정보 표시
        }
    } else {
        alert('출발지와 도착지를 모두 선택해 주세요.');
        console.log("출발지와 도착지가 설정되지 않았습니다.");
    }
});

    
    
    
    
    
    
    
    
       function logSelections() {
        const sidoText = $('#sido option:selected').text() || '';
        const cityText = $('#city option:selected').text() || '';
        const townText = $('#town option:selected').text() || '';

        const regionName = `${sidoText}${cityText}${townText}`;
        console.log(`선택된 지역명: ${regionName}`);
        geocoder.addressSearch(regionName, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                getoilgas(coords);
                map.setCenter(coords);
                
                
                addRegionMarker(coords, regionName);
                
                console.log("지도 위치가 업데이트되었습니다:", coords);
            } else {
                console.error("주소 검색 실패:", regionName);
            }
        });
    }

    $('#sido, #city, #town').on('change', logSelections);

    $(".regionban").click(function () {
        $("#regsec").css("display", "flex");
        $("#rousec").css("display", "none");
        $(".regionban").css("color", "#0d8aff");
        $(".routeban").css("color", "black");
        $(".regionban").addClass("active");
        $(".routeban").removeClass("active");
    });

    $(".routeban").click(function () {
        $("#regsec").css("display", "none");
        $("#rousec").css("display", "flex");
        $(".regionban").css("color", "black");
        $(".routeban").css("color", "#0d8aff");
        $(".routeban").addClass("active");
        $(".regionban").removeClass("active");
    });

    $('#sido').on('change', function () {
        const selectedSido = $(this).val();
        const citySelect = $('#city');
        citySelect.empty().append('<option selected disabled>시군구 선택</option>');

        if (regionData[selectedSido]) {
            regionData[selectedSido].forEach(city => {
                citySelect.append(new Option(city.name, city.code));
            });
        }
        $('#town').empty().append('<option selected disabled>읍면동 선택</option>');
    });

    $('#city').on('change', function () {
    clearRegionMarkers();
    clearGasStationMarkers();
    
        const selectedCity = $(this).val();
        const townSelect = $('#town');
        townSelect.empty().append('<option selected disabled>읍면동 선택</option>');

        townData.data.forEach(town => {
            if (town.Ccode.toString() === selectedCity) {
                townSelect.append(new Option(town.name, town.code));
            }
        });
    });
});